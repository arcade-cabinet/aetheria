Project Aetheria: Master Architecture & Design Document (v4.0 - Havok Edition)1. Project Vision & IP DefinitionTitle: Aetheria: The Fractured RealmGenre: Procedural Simulationist RPG (Mobile-First)Concept: The world is not fixed; it is reconstructed daily by the "World-Singers." The player is an Architect, exploring stabilizing realities.Visual Identity ("The Obsidian Interface"):Aesthetic: Dark Fantasy Minimalism. High contrast, neon-on-black, volumetric lighting.Palette:--void-base: #050505 (Background)--void-glass: rgba(20, 20, 25, 0.65) (UI Panels)--aether-light: #00f3ff (Magic/Stamina)--obsidian-highlight: #2b2b33 (Structural Edges)Visual Polish (Mandatory):All 3D scenes MUST use GlowLayer (for neon runes).All 3D scenes MUST use SSAO2 (for depth in procedural geometry).UI must use backdrop-filter: blur(12px).2. Tech Stack (Rebalanced)Core: React 19 + Vite + TypeScript.State: zustand (Game State) + miniplex (ECS).3D Engine: @babylonjs/core (v7.0+).Physics: @babylonjs/havok (WASM-based high-performance physics). CRITICAL UPGRADE.AI: yuka (Navigation & FSM).Audio: tone (Procedural Score).UI Animation: framer-motion (Preferred for React 19) OR animejs.Utils: seedrandom (Determinism), simplex-noise.3. Architecture: The Havok-ECS BridgeWe are moving from simple collisions to Havok V2 Physics.3.1. The Physics LoopMiniplex is the "Brain", Babylon/Havok is the "Body".Miniplex stores logic state (isFalling, health).Havok stores physical state (velocity, mass).RenderLoop:Read: Get mesh position from Physics Body.Logic: InputSystem applies Forces/Impulses (not direct position manipulation).Write: Physics engine updates Mesh position automatically.3.2. Character Controller (The "Capsule")Instead of a simple mesh, the Player is a PhysicsAggregate (Type: PhysicsShapeType.CAPSULE).Movement: Do NOT set position directly. Set body.setLinearVelocity().Jump: Apply body.applyImpulse(upVector).Ground Check: Use scene.onAfterPhysicsObservable with a ShapeCast or Raycast downwards.4. World Systems: The "Heavy" AssemblerWith Havok, the "Assembler" (World Builder) becomes a physics simulation.4.1. Dynamic ConstructionThe "Drop":Chunk loads.Entities (Walls, Props) spawn at Y=50.Physics: Entities have PhysicsAggregate (Box) with mass: 10.Constraint: They fall via real gravity.Locking: When velocity ~= 0 after impact, set body.setMassProperties({ mass: 0 }) (Turn Kinematic) to "lock" them into the world structure permanently.4.2. Debris & JuiceImpact: When a falling wall hits the ground (Physics Collision Event), spawn SolidParticleSystem dust.Camera Shake: Apply a momentary impulse to the Camera container based on the mass of the object that landed.5. Procedural Humanoid Generation (Havok Integration)5.1. The Physics RigThe "Block-Rig" is no longer just visual.Torso/Limbs: Primitive meshes.Ragdoll Potential: Connect limbs using PhysicsConstraint.BallAndSocket.State:Alive: Kinematic animation (procedural sine-waves driving rotation).Dead: Enable Physics on all limbs -> Instant Ragdoll.6. Directory Structure (Refined)src/
├── app/
│   ├── App.tsx             # Providers (Havok, Tone, Zustand)
│   └── store.ts            # Global Session State
├── ecs/
│   ├── World.ts            # Miniplex Instance
│   ├── systems/
│   │   ├── PhysicsSystem.ts    # Syncs Miniplex <-> Havok
│   │   ├── ControllerSystem.ts # Input -> Velocity
│   │   └── AssemblerSystem.ts  # Generates & Drops blocks
│   └── factories/          # Entity Creators (createPlayer, createWall)
├── features/
│   ├── ui/                 # React HUD (Inventory, Stats)
│   ├── audio/              # Tone.js synths
│   └── gen/                # Procedural Algorithms (Noise, DNA)
└── scene/
    ├── GameScene.tsx       # Babylon Canvas & Havok Init
    └── PostProcess.tsx     # SSAO, Glow, ColorGrading
