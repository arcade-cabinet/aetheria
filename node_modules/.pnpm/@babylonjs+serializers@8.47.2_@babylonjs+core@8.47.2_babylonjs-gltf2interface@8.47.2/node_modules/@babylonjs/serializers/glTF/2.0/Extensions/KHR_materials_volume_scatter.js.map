{"version":3,"file":"KHR_materials_volume_scatter.js","sourceRoot":"","sources":["../../../../../../dev/serializers/src/glTF/2.0/Extensions/KHR_materials_volume_scatter.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMaterial, IKHRMaterialsVolumeScatter } from \"babylonjs-gltf2interface\";\r\nimport type { IGLTFExporterExtensionV2 } from \"../glTFExporterExtension\";\r\nimport { GLTFExporter } from \"../glTFExporter\";\r\nimport type { Material } from \"core/Materials/material\";\r\nimport { OpenPBRMaterial } from \"core/Materials/PBR/openpbrMaterial\";\r\nimport type { BaseTexture } from \"core/Materials/Textures/baseTexture\";\r\nimport { Color3 } from \"core/Maths/math.color\";\r\nimport { Vector3 } from \"core/Maths/math.vector\";\r\n\r\nconst NAME = \"KHR_materials_volume_scatter\";\r\n\r\nfunction SingleScatterToMultiScatterAlbedo(singleScatter: Vector3): Vector3 {\r\n    const s = new Vector3(Math.sqrt(1.0 - singleScatter.x), Math.sqrt(1.0 - singleScatter.y), Math.sqrt(1.0 - singleScatter.z));\r\n    const ones = new Vector3(1.0, 1.0, 1.0);\r\n    const t = ones.subtract(s);\r\n    const p = ones.subtract(new Vector3(0.139, 0.139, 0.139).multiplyInPlace(s));\r\n    const k = ones.add(new Vector3(1.17, 1.17, 1.17).multiplyInPlace(s));\r\n\r\n    return t.multiplyInPlace(p).divideInPlace(k);\r\n}\r\n\r\n/**\r\n * TODO: In-progress specification\r\n * [Specification](https://github.com/KhronosGroup/glTF/blob/7ea427ed55d44427e83c0a6d1c87068b1a4151c5/extensions/2.0/Khronos/KHR_materials_volume_scatter/README.md)\r\n */\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport class KHR_materials_volume_scatter implements IGLTFExporterExtensionV2 {\r\n    /** Name of this extension */\r\n    public readonly name = NAME;\r\n\r\n    /** Defines whether this extension is enabled */\r\n    public enabled = true;\r\n\r\n    /** Defines whether this extension is required */\r\n    public required = false;\r\n\r\n    private _exporter: GLTFExporter;\r\n\r\n    private _wasUsed = false;\r\n\r\n    constructor(exporter: GLTFExporter) {\r\n        this._exporter = exporter;\r\n    }\r\n\r\n    public dispose() {}\r\n\r\n    /** @internal */\r\n    public get wasUsed() {\r\n        return this._wasUsed;\r\n    }\r\n\r\n    /**\r\n     * After exporting a material, deal with additional textures\r\n     * @param context GLTF context of the material\r\n     * @param node exported GLTF node\r\n     * @param babylonMaterial corresponding babylon material\r\n     * @returns array of additional textures to export\r\n     */\r\n    public async postExportMaterialAdditionalTexturesAsync?(context: string, node: IMaterial, babylonMaterial: Material): Promise<BaseTexture[]> {\r\n        const additionalTextures: BaseTexture[] = [];\r\n\r\n        if (babylonMaterial instanceof OpenPBRMaterial) {\r\n            if (babylonMaterial.transmissionWeight > 0) {\r\n                if (babylonMaterial.transmissionScatterTexture) {\r\n                    additionalTextures.push(babylonMaterial.transmissionScatterTexture);\r\n                }\r\n            }\r\n        }\r\n\r\n        return additionalTextures;\r\n    }\r\n\r\n    private _isExtensionEnabled(mat: OpenPBRMaterial): boolean {\r\n        // This extension must not be used on a material that also uses KHR_materials_unlit\r\n        if (mat.unlit) {\r\n            return false;\r\n        }\r\n        if (mat.transmissionWeight == 0 || mat.transmissionScatter.equals(Color3.Black())) {\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * After exporting a material\r\n     * @param context GLTF context of the material\r\n     * @param node exported GLTF node\r\n     * @param babylonMaterial corresponding babylon material\r\n     * @returns promise that resolves with the updated node\r\n     */\r\n    // eslint-disable-next-line no-restricted-syntax\r\n    public postExportMaterialAsync?(context: string, node: IMaterial, babylonMaterial: Material): Promise<IMaterial> {\r\n        return new Promise((resolve) => {\r\n            if (babylonMaterial instanceof OpenPBRMaterial && this._isExtensionEnabled(babylonMaterial)) {\r\n                this._wasUsed = true;\r\n                const invDepth = 1.0 / babylonMaterial.transmissionDepth;\r\n                const extinctionCoefficient = new Vector3(\r\n                    -Math.log(babylonMaterial.transmissionColor.r) * invDepth,\r\n                    -Math.log(babylonMaterial.transmissionColor.g) * invDepth,\r\n                    -Math.log(babylonMaterial.transmissionColor.b) * invDepth\r\n                );\r\n                const scatteringCoefficient = new Vector3(\r\n                    babylonMaterial.transmissionScatter.r * invDepth,\r\n                    babylonMaterial.transmissionScatter.g * invDepth,\r\n                    babylonMaterial.transmissionScatter.b * invDepth\r\n                );\r\n                const absorptionCoefficient = extinctionCoefficient.subtract(scatteringCoefficient);\r\n                const minCoeff = Math.min(absorptionCoefficient.x, absorptionCoefficient.y, absorptionCoefficient.z);\r\n                if (minCoeff < 0.0) {\r\n                    absorptionCoefficient.subtractInPlace(new Vector3(minCoeff, minCoeff, minCoeff));\r\n                    // Set extinction coefficient after shifting the absorption to be non-negative.\r\n                    extinctionCoefficient.copyFrom(absorptionCoefficient).addInPlace(scatteringCoefficient);\r\n                }\r\n\r\n                const ssAlbedo = new Vector3(\r\n                    scatteringCoefficient.x / extinctionCoefficient.x,\r\n                    scatteringCoefficient.y / extinctionCoefficient.y,\r\n                    scatteringCoefficient.z / extinctionCoefficient.z\r\n                );\r\n                const multiScatterColor = SingleScatterToMultiScatterAlbedo(ssAlbedo);\r\n\r\n                const volumeInfo: IKHRMaterialsVolumeScatter = {\r\n                    multiscatterColor: multiScatterColor.asArray(),\r\n                    scatterAnisotropy: babylonMaterial.transmissionScatterAnisotropy,\r\n                };\r\n\r\n                if (babylonMaterial.transmissionScatterTexture) {\r\n                    this._exporter._materialNeedsUVsSet.add(babylonMaterial);\r\n                    const transmissionTexture = this._exporter._materialExporter.getTextureInfo(babylonMaterial.transmissionScatterTexture);\r\n                    if (transmissionTexture) {\r\n                        volumeInfo.multiscatterColorTexture = transmissionTexture;\r\n                    }\r\n                }\r\n\r\n                node.extensions = node.extensions || {};\r\n                node.extensions[NAME] = volumeInfo;\r\n\r\n                // Now go back and set the extinction coefficient in the volume info.\r\n                if (node.extensions[\"KHR_materials_volume\"]) {\r\n                    const volumeExt = node.extensions[\"KHR_materials_volume\"] as any;\r\n                    const maxExtinction = Math.max(extinctionCoefficient.x, extinctionCoefficient.y, extinctionCoefficient.z);\r\n                    volumeExt.attenuationDistance = 1.0 / Math.max(maxExtinction, 0.0001);\r\n                    volumeExt.attenuationColor = new Color3(\r\n                        Math.exp(-extinctionCoefficient.x * volumeExt.attenuationDistance),\r\n                        Math.exp(-extinctionCoefficient.y * volumeExt.attenuationDistance),\r\n                        Math.exp(-extinctionCoefficient.z * volumeExt.attenuationDistance)\r\n                    ).asArray();\r\n                }\r\n            }\r\n            resolve(node);\r\n        });\r\n    }\r\n}\r\n\r\nGLTFExporter.RegisterExtension(NAME, (exporter) => new KHR_materials_volume_scatter(exporter), 101);\r\n"]}